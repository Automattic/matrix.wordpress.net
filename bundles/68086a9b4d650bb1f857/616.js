"use strict";(self.webpackChunkelement_web=self.webpackChunkelement_web||[]).push([[616],{"./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/EditWysiwygComposer.tsx":(e,t,s)=>{s.r(t),s.d(t,{default:()=>M});var o=s("./node_modules/@babel/runtime/helpers/esm/extends.js"),r=s("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),n=s("./node_modules/react/index.js"),a=s("./node_modules/classnames/index.js"),i=s.n(a),c=s("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/components/WysiwygComposer.tsx"),d=s("./node_modules/matrix-react-sdk/src/languageHandler.tsx"),l=s("./node_modules/matrix-react-sdk/src/components/views/elements/AccessibleButton.tsx");function m({onCancelClick:e,onSaveClick:t,isSaveDisabled:s=!1}){return n.createElement("div",{className:"mx_EditWysiwygComposer_buttons"},n.createElement(l.c,{kind:"secondary",onClick:e},(0,d._t)("action|cancel")),n.createElement(l.c,{kind:"primary",onClick:t,disabled:s},(0,d._t)("action|save")))}var u=s("./node_modules/matrix-react-sdk/src/dispatcher/dispatcher.ts"),p=s("./node_modules/matrix-react-sdk/src/dispatcher/actions.ts"),g=s("./node_modules/matrix-react-sdk/src/contexts/RoomContext.ts"),y=s("./node_modules/matrix-react-sdk/src/hooks/useDispatcher.ts"),_=s("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/hooks/utils.ts"),f=s("./node_modules/matrix-react-sdk/src/dispatcher/payloads/ComposerInsertPayload.ts"),x=s("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/utils/selection.ts"),v=s("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/ComposerContext.ts");var k=s("./node_modules/matrix-react-sdk/src/contexts/MatrixClientContext.tsx"),b=s("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/utils/editing.ts"),w=s("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/utils/message.ts");var h=s("./node_modules/matrix-react-sdk/src/editor/deserialize.ts"),C=s("./node_modules/matrix-react-sdk/src/editor/parts.ts"),E=s("./node_modules/matrix-react-sdk/src/settings/SettingsStore.ts");function T(e){const t=(0,g.cF)(),s=(0,k.uw)();return(0,n.useMemo)((()=>{if(e&&t.room&&s)return function(e,t,s){const o=new C.YH(t,s);let r=[];if(e.hasEditorState()){const t=e.getSerializedParts();null!==t&&(r=t.map((e=>o.deserializePart(e))))}else{if("org.matrix.custom.html"===e.getEvent().getContent().format)return function(e){var t;return(null===(t=e.getEvent().getContent().formatted_body)||void 0===t?void 0:t.replace(/<mx-reply>.*<\/mx-reply>/,""))||""}(e);r=(0,h.yG)(e.getEvent(),o,{shouldEscape:E.c.getValue("MessageComposerInput.useMarkdown")})}return r.reduce(((e,t)=>e+(null==t?void 0:t.text)),"")}(e,t.room,s)}),[e,t,s])}const S=["editorStateTransfer","className"],P=(0,n.forwardRef)((function({disabled:e=!1,composerFunctions:t},s){return function(e,t,s){const o=(0,g.cF)(),r=(0,v.E$)(),a=(0,n.useRef)(null),i=(0,n.useCallback)((n=>{var i;if(e||!t.current)return;const c=null!==(i=n.context)&&void 0!==i?i:g.Av.Room;switch(n.action){case p.S.FocusEditMessageComposer:(0,_.Om)(t,c,o,a);break;case p.S.ComposerInsert:if(n.timelineRenderingType!==o.timelineRenderingType)break;if(n.composerType!==f.C.Edit)break;n.text&&(0,x.S8)(r.selection).then((()=>s.insertText(n.text)))}}),[e,t,s,a,o,r]);(0,y.S)(u.cp,i)}(e,s,t),null}));function M(e){let{editorStateTransfer:t,className:s}=e,a=(0,r.c)(e,S);const d=(0,n.useRef)((0,v.L0)({editorStateTransfer:t})),l=T(t),u=!t||void 0!==l,{editMessage:p,endEditing:y,onChange:_,isSaveDisabled:f}=function(e,t){const s=(0,g.cF)(),o=(0,k.uw)(),[r,a]=(0,n.useState)(!0),[i,c]=(0,n.useState)(t);return{onChange:(0,n.useCallback)((e=>{c(e),a((s=>s&&e===t))}),[t]),editMessage:(0,n.useCallback)((async()=>{if(void 0!==o&&void 0!==i)return(0,w.editMessage)(i,{roomContext:s,mxClient:o,editorStateTransfer:e})}),[i,s,o,e]),endEditing:(0,n.useCallback)((()=>(0,b.s)(s)),[s]),isSaveDisabled:r}}(t,l);return u?n.createElement(v.UP.Provider,{value:d.current},n.createElement(c.q,(0,o.c)({className:i()("mx_EditWysiwygComposer",s),initialContent:l,onChange:_,onSend:p},a),((e,t)=>n.createElement(n.Fragment,null,n.createElement(P,{disabled:a.disabled,ref:e,composerFunctions:t}),n.createElement(m,{onCancelClick:y,onSaveClick:p,isSaveDisabled:f}))))):n.createElement(n.Fragment,null)}},"./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/utils/message.ts":(e,t,s)=>{s.r(t),s.d(t,{editMessage:()=>O,sendMessage:()=>M});var o=s("./node_modules/@babel/runtime/helpers/esm/objectWithoutProperties.js"),r=s("./node_modules/matrix-js-sdk/src/matrix.ts"),n=s("./node_modules/matrix-react-sdk/src/PosthogAnalytics.ts"),a=s("./node_modules/matrix-react-sdk/src/settings/SettingsStore.ts"),i=s("./node_modules/matrix-react-sdk/src/sendTimePerformanceMetrics.ts"),c=s("./node_modules/matrix-react-sdk/src/utils/local-room.ts"),d=s("./node_modules/matrix-react-sdk/src/effects/index.ts"),l=s("./node_modules/matrix-react-sdk/src/effects/utils.ts"),m=s("./node_modules/matrix-react-sdk/src/dispatcher/dispatcher.ts"),u=s("./node_modules/matrix-react-sdk/src/components/views/dialogs/ConfirmRedactDialog.tsx"),p=s("./node_modules/matrix-react-sdk/src/components/views/rooms/wysiwyg_composer/utils/editing.ts"),g=s("./node_modules/@babel/runtime/helpers/esm/defineProperty.js"),y=s("./node_modules/@matrix-org/matrix-wysiwyg/dist/matrix-wysiwyg.js"),_=s("./node_modules/matrix-react-sdk/src/utils/permalinks/Permalinks.ts"),f=s("./node_modules/matrix-react-sdk/src/utils/Reply.ts"),x=s("./node_modules/matrix-react-sdk/src/Typeguards.ts");function v(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,o)}return s}function k(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?v(Object(s),!0).forEach((function(t){(0,g.c)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):v(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const b="/me ";const w=e=>e instanceof r.MatrixEvent;async function h(e,t,{relation:s,replyToEvent:o,permalinkCreator:n,includeReplyLegacyFallback:i=!0,editedEvent:c}){const d=w(c),l=d?Boolean(c.replyEventId):w(o),m=d&&l,u=e.startsWith(b);u&&(e=e.slice(b.length)),e.startsWith("//")&&(e=e.slice(1));const p=t?await(0,y.richToPlain)(e,!1):function(e){const t=(new DOMParser).parseFromString(e,"text/html");return Array.from(t.querySelectorAll("a[data-mention-type]")).forEach((e=>{switch(e.getAttribute("data-mention-type")){case"at-room":e.replaceWith("@room");break;case"user":{const t=e.innerHTML;e.replaceWith(t);break}case"room":{const t=e.getAttribute("href");if(null===t)break;const s=(0,_.Gw)(t);(0,x.g)(s)&&(0,x.g)(s.roomIdOrAlias)&&e.replaceWith(s.roomIdOrAlias);break}}})),t.body.innerHTML}(e),g=m&&function(e){const t=e.getContent().body;if("string"!=typeof t)return"";const s=t.split("\n").map((e=>e.trim()));return s.length>2&&s[0].startsWith("> ")&&0===s[1].length?`${s[0]}\n\n`:""}(c)||"",v=m&&function(e){const t=e.getContent().formatted_body;if(!t)return"";const s=(new DOMParser).parseFromString(t,"text/html").body.querySelector("mx-reply");return s&&s.outerHTML||""}(c)||"",h={msgtype:u?r.MsgType.Emote:r.MsgType.Text,body:d?`${g} * ${p}`:p},C=a.c.getValue("MessageComposerInput.useMarkdown"),E=t?e:C?await(0,y.plainToRich)(e,!0):null;E&&(h.format="org.matrix.custom.html",h.formatted_body=d?`${v} * ${E}`:E),d&&(h["m.new_content"]={msgtype:h.msgtype,body:p},E&&(h["m.new_content"].format="org.matrix.custom.html",h["m.new_content"].formatted_body=E));return function(e,t){t&&(e["m.relates_to"]=k(k({},e["m.relates_to"]||{}),t))}(h,d?k(k({},s),{},{rel_type:"m.replace",event_id:c.getId()}):s),!d&&o&&n&&(0,f.YB)(h,o,{permalinkCreator:n,includeLegacyFallback:i}),h}var C=s("./node_modules/matrix-react-sdk/src/SlashCommands.tsx"),E=s("./node_modules/matrix-react-sdk/src/editor/commands.tsx"),T=s("./node_modules/matrix-react-sdk/src/dispatcher/actions.ts"),S=s("./node_modules/matrix-react-sdk/src/components/views/rooms/SendMessageComposer.tsx");const P=["roomContext","mxClient"];async function M(e,t,s){var u;let{roomContext:p,mxClient:g}=s,y=(0,o.c)(s,P);const{relation:_,replyToEvent:x,permalinkCreator:v}=y,{room:k}=p,w=null==k?void 0:k.roomId;if(!w)return;const M={eventName:"Composer",isEditing:!1,messageType:"Text",isReply:Boolean(x),inThread:(null==_?void 0:_.rel_type)===r.THREAD_RELATION_TYPE.name};n.gP.instance.trackEvent(M);let O=null;if(e.startsWith("/")&&!e.startsWith("//")&&!e.startsWith(b)){const{cmd:t,args:s}=(0,C.kX)(e);if(t){const e=(null==_?void 0:_.rel_type)===r.THREAD_RELATION_TYPE.name?null==_?void 0:_.event_id:null;let o;if([O,o]=await(0,E.yU)(g,t,s,w,null!=e?e:null),!o)return;if(!O||t.category!==C.Eb.messages&&t.category!==C.Eb.effects)return;var R,j;(0,S.kn)(O,_),x&&(0,f.YB)(O,x,{permalinkCreator:v,includeLegacyFallback:null===(R=null===(j=O.msgtype)||void 0===j?void 0:j.startsWith("m."))||void 0===R||R})}else{const t=await(0,E.ko)(e);if(m.cp.dispatch({action:T.S.FocusAComposer,context:p.timelineRenderingType}),!t)return}}if(null!==(u=O)&&void 0!==u||(O=await h(e,t,y)),!O.body.trim())return;a.c.getValue("Performance.addSendMessageTimingMetadata")&&(0,i.m)(O);const A=null!=_&&_.event_id&&(null==_?void 0:_.rel_type)===r.THREAD_RELATION_TYPE.name?_.event_id:null,W=(0,c.m)(w,(e=>g.sendMessage(e,A,O)),g);return x&&m.cp.dispatch({action:"reply_to_event",event:null,context:p.timelineRenderingType}),m.cp.dispatch({action:"message_sent"}),d.u.forEach((e=>{if(O&&(0,l.U)(O,e.emojis)){(null==_?void 0:_.rel_type)!==r.THREAD_RELATION_TYPE.name&&m.cp.dispatch({action:`effects.${e.command}`})}})),a.c.getValue("Performance.addSendMessageTimingMetadata")&&W.then((e=>{(0,i.Y)(g,w,e.event_id)})),a.c.getValue("scrollToBottomOnMessageSent")&&m.cp.dispatch({action:"scroll_to_bottom",timelineRenderingType:p.timelineRenderingType}),W}async function O(e,{roomContext:t,mxClient:s,editorStateTransfer:o}){const r=o.getEvent();n.gP.instance.trackEvent({eventName:"Composer",isEditing:!0,messageType:"Text",inThread:Boolean(null==r?void 0:r.getThread()),isReply:Boolean(r.replyEventId)});const a=await h(e,!0,{editedEvent:r}),i=a["m.new_content"];if(""===(null==i?void 0:i.body))return(0,p.W)(s,o),void(0,u.m)({mxEvent:r,onCloseDialog:()=>{(0,p.s)(t)}});let c;const d=r.getRoomId();if(function(e,t){const s=t.getEvent().getContent();return s.msgtype!==e.msgtype||s.body!==e.body||s.format!==e.format||s.formatted_body!==e.formatted_body}(i,o)&&d){(0,p.W)(s,o);const e=o.getEvent().threadRootId||null;c=s.sendMessage(d,e,a),m.cp.dispatch({action:"message_sent"})}return(0,p.s)(t),c}}}]);
//# sourceMappingURL=616.js.map